# Tooli AI Contributor Guide

Tooli is an agent-native CLI framework. AI agents should treat it as a typed command surface where each Python function becomes:

- A CLI command (human-first behavior)
- A machine contract (JSON schema and MCP tool metadata)
- A structured output stream (`--output json` envelope)
- Optional HTTP/API/doc generators

Use this guide when writing or changing Tooli code.

## Core API

- Public imports come from `tooli`:
  - `Tooli` (application entry point)
  - `Option`, `Argument`, `Annotated`
  - `StdinOr`, `SecretInput`
  - `dry_run_support`, `record_dry_action`
  - `DryRunRecorder`, `VersionFilter`, `compare_versions`
- Common annotation package:
  - `ReadOnly`, `Destructive`, `Idempotent`, `OpenWorld`

Minimal example:

```python
from pathlib import Path
from typing import Annotated

from tooli import Argument, Option, Tooli
from tooli.annotations import ReadOnly, Idempotent

app = Tooli(name="file-tools", version="2.0.0")

@app.command(
    annotations=ReadOnly | Idempotent,
    examples=[{"args": ["--pattern", "*.py"]}],
)
def find_files(
    pattern: Annotated[str, Argument(help="Glob pattern")],
    root: Annotated[Path, Option(help="Root directory")] = Path("."),
) -> list[dict[str, object]]:
    return []

if __name__ == "__main__":
    app()
```

## Command behavior you must preserve

- Return values are routed through Tooliâ€™s invoke pipeline, never print directly for machine paths.
- Non-TTY output is JSON envelope by default (`--json` mode is explicit equivalent).
- Envelope shape:
  - `ok: bool`
  - `result: <return value>` (or `null` on error)
  - `meta: {tool, version, duration_ms, warnings}`
- `None` return values should still follow normal CLI semantics (typically no output).
- Errors should use `tooli.errors` where possible; avoid raw `Exception` unless it is intentionally wrapped.
- Validation and parser failures should ideally use existing `InputError`/`ToolError` contracts.

## Command metadata and validation

Use command metadata sparingly but explicitly where behavior matters for agents:

- `annotations`: capability hints for safety and planning
- `examples`: structured learning hints for docs and agents
- `timeout`: runtime guard
- `human_in_the_loop`: prompts before execution
- `requires_approval` + `danger_level`: governance intent (planned for v2 hardening)
- `auth`: required scopes
- `version`: per-command versioning marker
- `max_tokens`: token-budget hint used by context truncation runtime
- `allow_python_eval`: opt-in eval-mode for stdin payload injection
- `paginated`: enable pagination controls on list-like returns
- `list_processing`: enables `--null` parse behavior for lists

## Input conventions

- Use `StdinOr[T]` for file-or-url-or-stdin inputs that can be reused by CLI and agents.
- Use `SecretInput[T]` for values that should be redacted.
- Use `--schema` for contract-level debugging and expected argument shape.
- Use `--help-agent` output when you want machine-friendly command metadata.

## Global flags to respect

The app injects these automatically:

- `--output / -o` with `auto|json|jsonl|text|plain`
- `--json`, `--jsonl`, `--text`, `--plain`
- `--quiet`, `--verbose`
- `--dry-run`
- `--yes`
- `--timeout`
- `--schema`
- `--response-format`
- `--help-agent`
- `--print0` (for list text output)
- `--null` (for list parsing)
- `--no-color`

Do not shadow these names in command signatures.

## Built-in surface and extension points

- Hidden built-ins include:
  - `mcp export` and `mcp serve`
  - `api export-openapi` and `api serve`
  - `docs llms` and `docs man`
  - `generate-skill`
  - `tooli_read_page`
  - `orchestrate run`
- `orchestrate run` can execute JSON/Python plan payloads for multi-tool workflows.

## Testing expectations

For every behavior change:

1. Add/adjust tests in `tests/` that invoke the app with `CliRunner`.
2. Verify both success and error envelopes for structured error contracts.
3. Cover non-TTY behavior for machine output paths.
4. Run command-level regressions for global flags involved (`--json`, `--jsonl`, `--text`, `--help-agent`, `--schema`, `--timeout`).
5. Keep tests deterministic on Python 3.10/3.11/3.12.

Prefer file-local fixtures over broad monkeypatches. Keep tests explicit and minimal.

## Quality and lint expectations

- Format with project standards (ruff).
- Preserve type safety with mypy-compatible signatures and annotations.
- Follow existing `tests/`, not ad-hoc integration-only assertions.
- Keep output/error contracts stable unless an issue is explicitly changing compatibility.

## Typical safe edits

- Add metadata and tests before documenting behavior changes.
- Update generated docs in examples and README/CHANGELOG only when user-facing behavior changed.
- For protocol-safe work (errors, schema, flags), run full test subset relevant to command output and CLI parsing.
- When uncertain, prefer existing utility helpers in `tooli/*` over custom implementations.

## Current implementation checkpoints (high-level)

- v2.0 release includes MCP serving, schema export, token budget helpers, and `allow_python_eval`.
- Programmatic orchestration is available via `orchestrate run` (JSON/Python plans).
- v2 roadmap items remain staged and should be implemented behind explicit feature flags and acceptance checks.
